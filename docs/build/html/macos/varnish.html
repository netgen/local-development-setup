<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Set up Varnish reverse HTTP proxy &mdash; Netgen&#39;s Local Development Setup  documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../_static/doctools.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Set up Node.js version management" href="nodejs.html" />
    <link rel="prev" title="Set up MailHog development SMTP server" href="mailhog.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html" class="icon icon-home"> Netgen's Local Development Setup
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../overview/index.html">Netgen’s Local Development Setup</a></li>
</ul>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="index.html">MacOS</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="prerequisites.html">MacOS prerequisites</a></li>
<li class="toctree-l2"><a class="reference internal" href="git.html">Set up Git version control system</a></li>
<li class="toctree-l2"><a class="reference internal" href="git.html#tips">Tips</a></li>
<li class="toctree-l2"><a class="reference internal" href="dnsmasq.html">Set up DNS forwarding with dnsmasq</a></li>
<li class="toctree-l2"><a class="reference internal" href="mysql.html">Set up MySQL database server</a></li>
<li class="toctree-l2"><a class="reference internal" href="php.html">Set up PHP</a></li>
<li class="toctree-l2"><a class="reference internal" href="composer.html">Set up composer</a></li>
<li class="toctree-l2"><a class="reference internal" href="ssl.html">Set up SSL certificates with OpenSSL</a></li>
<li class="toctree-l2"><a class="reference internal" href="ssl.html#adding-new-domains">Adding new domains</a></li>
<li class="toctree-l2"><a class="reference internal" href="ssl.html#browser-specifics">Browser specifics</a></li>
<li class="toctree-l2"><a class="reference internal" href="nginx.html">Set up NGINX web server</a></li>
<li class="toctree-l2"><a class="reference internal" href="nginx.html#testing-your-website-on-a-different-device">Testing your website on a different device</a></li>
<li class="toctree-l2"><a class="reference internal" href="curl.html">Set up cURL</a></li>
<li class="toctree-l2"><a class="reference internal" href="redis.html">Set up Redis in-memory data store</a></li>
<li class="toctree-l2"><a class="reference internal" href="solr.html">Set up Apache Solr</a></li>
<li class="toctree-l2"><a class="reference internal" href="rabbitmq.html">Set up RabbitMQ message-broker</a></li>
<li class="toctree-l2"><a class="reference internal" href="mailhog.html">Set up MailHog development SMTP server</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Set up Varnish reverse HTTP proxy</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#install-varnish">1 Install Varnish</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#download-varnish">1.1 Download Varnish</a></li>
<li class="toctree-l4"><a class="reference internal" href="#patch-varnish">1.2 Patch Varnish</a></li>
<li class="toctree-l4"><a class="reference internal" href="#install-tools-needed-to-compile-varnish">1.3 Install tools needed to compile Varnish</a></li>
<li class="toctree-l4"><a class="reference internal" href="#compile-and-install-varnish">1.4 Compile and install Varnish</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#install-varnish-modules">2 Install Varnish modules</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#clone-repository">2.1 Clone repository</a></li>
<li class="toctree-l4"><a class="reference internal" href="#compile-and-install-varnish-modules">2.2 Compile and install Varnish modules</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#start">3 Start</a></li>
<li class="toctree-l3"><a class="reference internal" href="#configure-vcl">4 Configure VCL</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="nodejs.html">Set up Node.js version management</a></li>
<li class="toctree-l2"><a class="reference internal" href="tika.html">Set up Apache Tika server (optional)</a></li>
<li class="toctree-l2"><a class="reference internal" href="memcached.html">Set up Memcached distributed memory object caching system</a></li>
<li class="toctree-l2"><a class="reference internal" href="xdebug.html">Set up XDebug</a></li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../ubuntu/index.html">Ubuntu</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Netgen's Local Development Setup</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="index.html">MacOS</a> &raquo;</li>
      <li>Set up Varnish reverse HTTP proxy</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/macos/varnish.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="set-up-varnish-reverse-http-proxy">
<h1>Set up Varnish reverse HTTP proxy<a class="headerlink" href="#set-up-varnish-reverse-http-proxy" title="Permalink to this heading">¶</a></h1>
<section id="install-varnish">
<h2>1 Install Varnish<a class="headerlink" href="#install-varnish" title="Permalink to this heading">¶</a></h2>
<p>Since Varnish is not widely available in all necessary versions, here
you will compile it from downloaded source.</p>
<section id="download-varnish">
<h3>1.1 Download Varnish<a class="headerlink" href="#download-varnish" title="Permalink to this heading">¶</a></h3>
<p>Download the required Varnish source from GitHub to your home directory:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">mkdir ~/varnish</span>
<span class="go">cd ~/varnish</span>
<span class="go">wget https://github.com/varnishcache/varnish-cache/archive/varnish-6.0.6.tar.gz</span>
</pre></div>
</div>
<p>Extract the downloaded archive and position into it:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">cd ~/varnish</span>
<span class="go">tar xzf varnish-6.0.6.tar.gz &amp;&amp; rm varnish-6.0.6.tar.gz</span>
<span class="go">cd varnish-cache-varnish-6.0.6</span>
</pre></div>
</div>
</section>
<section id="patch-varnish">
<h3>1.2 Patch Varnish<a class="headerlink" href="#patch-varnish" title="Permalink to this heading">¶</a></h3>
<p>As nicely explained at
<a class="reference external" href="https://varnish-cache.org/docs/6.0/phk/platforms.html">https://varnish-cache.org/docs/6.0/phk/platforms.html</a>, MacOS is not the
primary platform Varnish team cares about. They will try not to break
it, but will not regularly test it and may rely on contributors to alert
about problems. Since you use MacOS, and our web technology of choice
forces us to use a bit older version of Varnish, you will need to
manually apply some patches existing in the newer versions.</p>
<p>Execute on the command line:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">cd ~/varnish/varnish-cache-varnish-6.0.6</span>
<span class="go">subl bin/varnishd/cache/cache_lck.c</span>
</pre></div>
</div>
<p>Then manually apply the following commit:
<a class="reference external" href="https://github.com/varnishcache/varnish-cache/commit/e5e545f9fe14b4bfd4003c26403d80645c73385a">https://github.com/varnishcache/varnish-cache/commit/e5e545f9fe14b4bfd4003c26403d80645c73385a</a></p>
</section>
<section id="install-tools-needed-to-compile-varnish">
<h3>1.3 Install tools needed to compile Varnish<a class="headerlink" href="#install-tools-needed-to-compile-varnish" title="Permalink to this heading">¶</a></h3>
<p>Install <code class="docutils literal notranslate"><span class="pre">automake</span></code> using <code class="docutils literal notranslate"><span class="pre">brew</span></code> if you don’t already have it:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">brew info automake</span>
<span class="go">brew install automake</span>
</pre></div>
</div>
</section>
<section id="compile-and-install-varnish">
<h3>1.4 Compile and install Varnish<a class="headerlink" href="#compile-and-install-varnish" title="Permalink to this heading">¶</a></h3>
<p>Execute the following to compile and install Varnish binaries:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">cd ~/varnish/varnish-cache-varnish-6.0.6</span>
<span class="go">./autogen.sh</span>
<span class="go">./configure</span>
<span class="go">make</span>
<span class="go">sudo make install</span>
</pre></div>
</div>
<p>Once the process has finished, Varnish binaries will be installed on
paths <code class="docutils literal notranslate"><span class="pre">/usr/local/bin</span></code> and <code class="docutils literal notranslate"><span class="pre">/usr/local/sbin</span></code>. If these are not
already under your environment <code class="docutils literal notranslate"><span class="pre">PATH</span></code> variable, leave them be where
they are and just symlink them to your user’s <code class="docutils literal notranslate"><span class="pre">bin</span></code> directory:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">cd ~/bin</span>
<span class="go">ln -s /usr/local/bin/varnishadm</span>
<span class="go">ln -s /usr/local/bin/varnishhist</span>
<span class="go">ln -s /usr/local/bin/varnishlog</span>
<span class="go">ln -s /usr/local/bin/varnishncsa</span>
<span class="go">ln -s /usr/local/bin/varnishstat</span>
<span class="go">ln -s /usr/local/bin/varnishtest</span>
<span class="go">ln -s /usr/local/bin/varnishtop</span>
<span class="go">ln -s /usr/local/sbin/varnishd</span>
</pre></div>
</div>
</section>
</section>
<section id="install-varnish-modules">
<h2>2 Install Varnish modules<a class="headerlink" href="#install-varnish-modules" title="Permalink to this heading">¶</a></h2>
<p>Aside from standard Varnish installation, you’ll need <code class="docutils literal notranslate"><span class="pre">xkey</span></code> module as
well.</p>
<section id="clone-repository">
<h3>2.1 Clone repository<a class="headerlink" href="#clone-repository" title="Permalink to this heading">¶</a></h3>
<p>Clone modules repository into your home directory, position into it and
checkout branch <code class="docutils literal notranslate"><span class="pre">6.0-lts</span></code>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">cd ~/varnish</span>
<span class="go">git clone https://github.com/varnish/varnish-modules.git</span>
<span class="go">cd varnish-modules</span>
<span class="go">git checkout 6.0-lts</span>
</pre></div>
</div>
</section>
<section id="compile-and-install-varnish-modules">
<h3>2.2 Compile and install Varnish modules<a class="headerlink" href="#compile-and-install-varnish-modules" title="Permalink to this heading">¶</a></h3>
<p>Execute the following to compile and install module binaries:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">cd ~/varnish/varnish-modules</span>
<span class="go">export PKG_CONFIG_PATH=/usr/local/lib/pkgconfig</span>
<span class="go">./bootstrap</span>
<span class="go">./configure</span>
<span class="go">make</span>
<span class="go">sudo make install</span>
</pre></div>
</div>
</section>
</section>
<section id="start">
<h2>3 Start<a class="headerlink" href="#start" title="Permalink to this heading">¶</a></h2>
<p>Now start the server in the foreground on the port 8081, replacing the
example path to VCL with correct one for your project:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">varnishd -f /path/to/configuration.vcl -a :8081 -s malloc,256M -F</span>
</pre></div>
</div>
<p>With these options, configure <code class="docutils literal notranslate"><span class="pre">purge_server</span></code> in your eZ Platform
installation to <code class="docutils literal notranslate"><span class="pre">http://localhost:8081</span></code>.</p>
<p>If needed you can adjust the amount of memory given to the Varnish
server (256M in the above example). Stop the server when needed with
<code class="docutils literal notranslate"><span class="pre">Control-C</span></code>.</p>
</section>
<section id="configure-vcl">
<h2>4 Configure VCL<a class="headerlink" href="#configure-vcl" title="Permalink to this heading">¶</a></h2>
<p>In instructions for macOS (above) Varnish is started from the command
line when needed, and the VCL configuration is provided as a parameter
to the starting command, so there is no need to configure it separately.</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="mailhog.html" class="btn btn-neutral float-left" title="Set up MailHog development SMTP server" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="nodejs.html" class="btn btn-neutral float-right" title="Set up Node.js version management" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, Netgen.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>